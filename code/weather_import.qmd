---
title: "Weather Data Import"
format: html
---

# Setup  
```{r}
#| message: false
#| warning: false

#install.packages("sf")
#install.packages("daymetr")
#install.packages("remotes")
#remotes::install_github("ropensci/USAboundaries")
#remotes::install_github("ropensci/USAboundariesData")

library(tidyverse)
library(USAboundaries) # for US state boundaries
library(sf) # for US map
library(daymetr)
```

```{r}
field <- read.csv("../data/raw/training_meta.csv")

field
```

# EDA  
```{r}
summary(field)
```

```{r deleting Germany}
fieldw <- filter(field, longitude < 0)
summary(fieldw)
```


```{r unique years}
unique(fieldw$year) %>% length()
```
```{r unique sites}
unique(fieldw$site) %>% length
```

```{r}
states <- us_states() %>% 
  filter( !(state_abbr %in% c("PR", "AK", "HI") ) )

states


ggplot()+
  geom_sf(data = states) +
  geom_point(data = fieldw,
             aes(x = longitude,
                 y = latitude))

```

# Open weather data - all site years


```{r weather data}
daymet_all <- fieldw %>%
  mutate(weather = pmap(list(.y = year,
                        .site = site,
                        .lat = latitude,
                        .lon = longitude),
                    function(.y, .site, .lat, .lon)
                      download_daymet(
                        site = .site,
                        lat = .lat,
                        lon = .lon,
                        start = .y,
                        end = .y,
                        simplify = T,
                        silent = T
                      ) %>%
                    rename(.year = year,
                           .site = site, 
                           .lat = latitude,
                           .lon = longitude
                           )
                    ))

head(daymet_all)
```


```{r unnest}
daymet_all_unnest <- daymet_all %>%
  unnest(weather) %>%
  pivot_wider(names_from = measurement,
              values_from = value
              ) %>%
  janitor::clean_names()

daymet_all_unnest


```

 
```{r save partially cleaned weather data}
write_csv(daymet_all_unnest,
          "../data/weather_partial.csv"
          )
```


# Summary  
In this exercise, we:  
  - Used year, longitude, and latitude to pull daily weather data from Daymet  
  - Wrote code to automate and iterate this process for 698 site-years  
  - Exported the data for future reuse  

# Other open-source data APIs in R  
There are MANY open-source data APIs relevant for agriculture applications, most of which have an R implementation.  

Some of the ones I used in the past:  
  - **USDA NASS crop statistics**: https://cran.r-project.org/web/packages/rnassqs/vignettes/rnassqs.html  
  - Soil properties:  
    - **POLARIS**: https://github.com/lhmrosso/XPolaris  
    - **Soilsgrid**: https://rpubs.com/ials2un/soilgrids_webdav  
    - **SSURGO**: https://search.r-project.org/CRAN/refmans/FedData/html/get_ssurgo.html    
  - **Soil water**: https://leombastos.github.io/bastoslab/teaching/2023-aghack-vwc/2023-aghack-vwc.html     
  - **Drought monitor**: https://droughtmonitor.unl.edu/DmData/DataDownload/WebServiceInfo.aspx    
  - **Remote sensing**: https://github.com/bevingtona/planetR  
  - **Elevation**: https://github.com/jhollist/elevatr  
  





